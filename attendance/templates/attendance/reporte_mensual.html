<!-- attendance/templates/attendance/reporte_mensual.html -->
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte Mensual de Asistencias</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <!-- Navegación -->
    <nav class="bg-gradient-to-r from-indigo-600 to-purple-700 shadow-lg">
        <div class="container mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-white">Reporte Mensual de Asistencias</h1>
                    <p class="text-indigo-100 text-sm">
                        {% load static %}
                        Período:
                        {% if mes == 1 %}Enero{% elif mes == 2 %}Febrero{% elif mes == 3 %}Marzo{% elif mes == 4 %}Abril{% elif mes == 5 %}Mayo{% elif mes == 6 %}Junio{% elif mes == 7 %}Julio{% elif mes == 8 %}Agosto{% elif mes == 9 %}Septiembre{% elif mes == 10 %}Octubre{% elif mes == 11 %}Noviembre{% else %}Diciembre{% endif %} {{ anio }}
                    </p>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="{% url 'dashboard' %}" class="bg-white text-indigo-600 px-4 py-2 rounded-lg hover:bg-indigo-50 transition font-semibold">
                        Dashboard
                    </a>
                    <button onclick="window.print()" class="bg-indigo-800 text-white px-4 py-2 rounded-lg hover:bg-indigo-900 transition font-semibold">
                        Imprimir
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-8">
        <!-- Selector de mes/año -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8 no-print">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Seleccionar Período</h2>
            <form method="get" class="flex flex-wrap gap-4 items-end">
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">Mes</label>
                    <select name="mes" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                        <option value="1" {% if mes == 1 %}selected{% endif %}>Enero</option>
                        <option value="2" {% if mes == 2 %}selected{% endif %}>Febrero</option>
                        <option value="3" {% if mes == 3 %}selected{% endif %}>Marzo</option>
                        <option value="4" {% if mes == 4 %}selected{% endif %}>Abril</option>
                        <option value="5" {% if mes == 5 %}selected{% endif %}>Mayo</option>
                        <option value="6" {% if mes == 6 %}selected{% endif %}>Junio</option>
                        <option value="7" {% if mes == 7 %}selected{% endif %}>Julio</option>
                        <option value="8" {% if mes == 8 %}selected{% endif %}>Agosto</option>
                        <option value="9" {% if mes == 9 %}selected{% endif %}>Septiembre</option>
                        <option value="10" {% if mes == 10 %}selected{% endif %}>Octubre</option>
                        <option value="11" {% if mes == 11 %}selected{% endif %}>Noviembre</option>
                        <option value="12" {% if mes == 12 %}selected{% endif %}>Diciembre</option>
                    </select>
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">Año</label>
                    <select name="anio" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                        {% for y in years_disponibles %}
                        <option value="{{ y }}" {% if anio|stringformat:"i" == y %}selected{% endif %}>{{ y }}</option>
                        {% endfor %}
                    </select>
                </div>
                <button type="submit" class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white font-bold py-2 px-6 rounded-lg hover:from-indigo-600 hover:to-purple-700 transition shadow-lg">
                    Consultar
                </button>
            </form>
        </div>

        <!-- Estadísticas Generales -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            {% with total_empleados=empleados_data|length %}
            <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-blue-500">
                <p class="text-gray-500 text-sm font-semibold uppercase mb-2">Total Empleados</p>
                <p class="text-4xl font-bold text-gray-800">{{ total_empleados }}</p>
            </div>

            {% with total_retardos=0 %}
                {% for emp in empleados_data %}
                    {% with total_retardos=total_retardos|add:emp.retardos %}{% endwith %}
                {% endfor %}
                <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-red-500">
                    <p class="text-gray-500 text-sm font-semibold uppercase mb-2">Total Retardos</p>
                    <p class="text-4xl font-bold text-gray-800">
                        {% for emp in empleados_data %}{{ emp.retardos|default:0 }}{% if not forloop.last %}+{% endif %}{% endfor %}
                    </p>
                </div>
            {% endwith %}

            <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-green-500">
                <p class="text-gray-500 text-sm font-semibold uppercase mb-2">Promedio Asistencia</p>
                <p class="text-4xl font-bold text-gray-800">
                    {% widthratio empleados_data|length total_empleados 100 %}%
                </p>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-purple-500">
                <p class="text-gray-500 text-sm font-semibold uppercase mb-2">Período</p>
                <p class="text-2xl font-bold text-gray-800">
                    {{ mes }}/{{ anio }}
                </p>
            </div>
            {% endwith %}
        </div>

        <!-- Tabla de Asistencias -->
        <div class="bg-white rounded-xl shadow-lg overflow-hidden">
            <div class="p-6 bg-gradient-to-r from-indigo-600 to-purple-700">
                <h2 class="text-2xl font-bold text-white flex items-center">
                    <svg class="w-8 h-8 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    Detalle de Asistencias por Empleado
                </h2>
            </div>

            {% if empleados_data %}
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">
                                Empleado
                            </th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">
                                Código
                            </th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">
                                Departamento
                            </th>
                            <th class="px-6 py-4 text-center text-xs font-bold text-gray-700 uppercase tracking-wider">
                                Días Asistidos
                            </th>
                            <th class="px-6 py-4 text-center text-xs font-bold text-gray-700 uppercase tracking-wider">
                                Retardos
                            </th>
                            <th class="px-6 py-4 text-center text-xs font-bold text-gray-700 uppercase tracking-wider">
                                Min. Retardo
                            </th>
                            <th class="px-6 py-4 text-center text-xs font-bold text-gray-700 uppercase tracking-wider">
                                Puntualidad
                            </th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for emp_data in empleados_data %}
                        <tr class="hover:bg-gray-50 transition">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0 h-10 w-10 bg-gradient-to-br from-indigo-400 to-purple-500 rounded-full flex items-center justify-center">
                                        <span class="text-white font-bold text-sm">
                                            {{ emp_data.empleado.user.first_name|first }}{{ emp_data.empleado.user.last_name|first }}
                                        </span>
                                    </div>
                                    <div class="ml-4">
                                        <div class="text-sm font-medium text-gray-900">
                                            {{ emp_data.empleado.user.get_full_name }}
                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                                {{ emp_data.empleado.codigo_empleado }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                                {{ emp_data.empleado.departamento.nombre|default:"N/A" }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-center">
                                <span class="px-3 py-1 inline-flex text-sm leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
                                    {{ emp_data.total_dias }}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-center">
                                {% if emp_data.retardos > 0 %}
                                <span class="px-3 py-1 inline-flex text-sm leading-5 font-semibold rounded-full bg-red-100 text-red-800">
                                    {{ emp_data.retardos }}
                                </span>
                                {% else %}
                                <span class="px-3 py-1 inline-flex text-sm leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                                    0
                                </span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-600">
                                {{ emp_data.total_minutos_retardo }} min
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-center">
                                {% if emp_data.total_dias > 0 %}
                                    {% widthratio emp_data.total_dias emp_data.retardos -100 as puntualidad %}
                                    {% if emp_data.retardos == 0 %}
                                        <span class="px-3 py-1 inline-flex text-sm leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                                            100%
                                        </span>
                                    {% else %}
                                        {% widthratio emp_data.retardos emp_data.total_dias 100 as porcentaje_retardos %}
                                        {% with puntualidad=100|add:porcentaje_retardos|add:"-200" %}
                                        <span class="px-3 py-1 inline-flex text-sm leading-5 font-semibold rounded-full {% if puntualidad >= 95 %}bg-green-100 text-green-800{% elif puntualidad >= 80 %}bg-yellow-100 text-yellow-800{% else %}bg-red-100 text-red-800{% endif %}">
                                            {% widthratio emp_data.total_dias emp_data.retardos -100 %}{{ puntualidad|floatformat:0 }}%
                                        </span>
                                        {% endwith %}
                                    {% endif %}
                                {% else %}
                                <span class="text-gray-400">N/A</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Leyenda -->
            <div class="p-6 bg-gray-50 border-t border-gray-200">
                <h3 class="text-sm font-bold text-gray-700 mb-3">Leyenda de Puntualidad:</h3>
                <div class="flex flex-wrap gap-4 text-sm">
                    <div class="flex items-center">
                        <span class="px-2 py-1 rounded-full bg-green-100 text-green-800 mr-2">●</span>
                        <span class="text-gray-600">95% - 100%: Excelente</span>
                    </div>
                    <div class="flex items-center">
                        <span class="px-2 py-1 rounded-full bg-yellow-100 text-yellow-800 mr-2">●</span>
                        <span class="text-gray-600">80% - 94%: Bueno</span>
                    </div>
                    <div class="flex items-center">
                        <span class="px-2 py-1 rounded-full bg-red-100 text-red-800 mr-2">●</span>
                        <span class="text-gray-600">Menos de 80%: Requiere atención</span>
                    </div>
                </div>
            </div>

            {% else %}
            <!-- Sin datos -->
            <div class="p-12 text-center">
                <svg class="w-24 h-24 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                <h3 class="text-xl font-bold text-gray-600 mb-2">No hay datos disponibles</h3>
                <p class="text-gray-500">No se encontraron registros de asistencia para el período seleccionado</p>
            </div>
            {% endif %}
        </div>

        <!-- Footer con información -->
        <div class="mt-8 bg-white rounded-xl shadow-lg p-6">
            <div class="flex items-start">
                <svg class="w-6 h-6 text-blue-500 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <div>
                    <h3 class="font-bold text-gray-800 mb-2">Notas:</h3>
                    <ul class="text-sm text-gray-600 space-y-1">
                        <li>• Los días asistidos cuentan únicamente los registros de entrada</li>
                        <li>• Se considera retardo después de 15 minutos de tolerancia</li>
                        <li>• El porcentaje de puntualidad se calcula: (días sin retardo / días asistidos) × 100</li>
                        <li>• Este reporte se genera automáticamente los días 13 y 28 de cada mes</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Información de generación -->
        <div class="mt-4 text-center text-sm text-gray-500">
            <p>Reporte generado el {% now "d/m/Y H:i" %} hrs</p>
        </div>
    </div>

    <!-- Estilos para impresión -->
    <style>
        @media print {
            .no-print {
                display: none !important;
            }
            body {
                background: white;
            }
            .shadow-lg {
                box-shadow: none !important;
            }
        }
    </style>
</body>
</html>